<!DOCTYPE html>
<html>
<head>
	<script>var sforthThrowOnUnderflow=false;</script>
	<meta charset="utf-8"/>
	<title>Raytracer</title>
	<script src="../../ext/jquery-2.1.0.min.js"></script>
	<script src="../../sforth-runtime.js"></script>
	<script src="../../sforth.js"></script>
</head>
<body>
	<script data-src="../../forth.fs;../../browser.fs" type="application/sforth"></script>

	<script type="application/sforth" data-id="raytracer-worker" data-type="javascript/worker"
		data-src="../../sforth-runtime.js;../../forth.fs;raytracer.fs" data-throw-on-underflow="true">
		:jsnoname { e }
			e.data.id { id }
			e.data.scene { scene }
			e.data.width { width }
			e.data.height { height }
			e.data.y_start { y_start }
			e.data.y_end { y_end }
			new RayTracer { rayTracer }

			: paint-line { y data }
				' y null = if
					:[ { id: id, done: true } ]: self.postMessage(1)
					self.close
					exit
				endif
				:[ { id: id, y: y, data: data } ]: self.postMessage(1)
			;

			default-scene width height y_start y_end ' paint-line rayTracer.render
		; to self.onmessage
	</script>

	<script type="application/sforth">
		false { is-currently-rendering }
		:js renderToCanvas { }
			is-currently-rendering if
				»Rendering was already started« console-log
				exit
			endif
			true to is-currently-rendering
			:[ document.getElementById('worker-count').value ]: { workerCount }
			:[ document.getElementById('width').value ]: { width }
			:[ document.getElementById('height').value ]: { height }
			"processing-time document.getElementById(1) { processing-time }

			// disable the render button
			"render-button document.getElementById(1) { render-button }
			true to render-button.disabled

			"canvas document.getElementById(1) { canvas }
			"2d canvas.getContext(1) { ctx }

			width to canvas.width
			height to canvas.height

			workerCount { active-worker }

			width 1 ctx.createImageData(2) { line }

			»« to processing-time.value
			time-in-ms { start-time }

			:js worker-onmessage { e }
				e.data.id { id }
				' e.data.done if
					// Worker is done
					active-worker 1 - to active-worker
					active-worker 0 = if
						time-in-ms start-time - { required-time }
						required-time » ms« + to processing-time.value
						false to is-currently-rendering

						// enable the render-button
						false to render-button.disabled

						// enable the download-button
						"download-button document.getElementById(1) { download-button }
						false to download-button.disabled
					endif
					exit
				endif
				e.data.y { y }
				e.data.data { data }
				data line.data.set(1)
				' line 0 y ctx.putImageData
			;

			:js worker-onerror { e }
				»web worker error: « e.message + console-log
			;

			0 workerCount 1 do i
				"#raytracer-worker create-worker { worker }

				' worker-onmessage to worker.onmessage
				' worker-onerror to worker.onerror

				:[ {
					id: i,
					scene: null,
					width: width,
					height: height,
					y_start: (height/workerCount)*i,
					y_end: (height/workerCount)*(i+1)
				} ]:
				worker.postMessage
			loop
		;

		:js downloadImage { }
			"canvas document.getElementById { canvas }
			"2d canvas.getContext(1) { ctx }
			"image/webp canvas.toDataURL(1) { image } "image/webp "image/octet-stream image.replace 'new_window' window.open
		;
	</script>

	Worker <input id="worker-count" type="text" size="30" maxlength="30" value="16">
	Width: <input id="width" type="text" size="30" maxlength="30" value="2000">
	Height: <input id="height" type="text" size="30" maxlength="30" value="2000">
	Time: <input id="processing-time" type="text" size="30" maxlength="30" readonly>
	<input type="button" id="render-button" value="Render" onclick="renderToCanvas();">
	<input type="button" id="download-button" value="Download" onclick="downloadImage();" disabled="true">
	<br>
	<canvas id="canvas"></canvas>
</body>
</html>