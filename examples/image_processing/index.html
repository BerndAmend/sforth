<!DOCTYPE html>
<html>
<head>
	<script>var sforthThrowOnUnderflow=false;</script>
	<meta charset="utf-8"/>
	<title>Image processing</title>
	<script src="../../ext/jquery-2.1.0.min.js"></script>
	<script src="../../sforth-runtime.js"></script>
	<script src="../../sforth.js"></script>
	<script src="image-processing.js"></script>

	<style>
		/*#canvas-output1 {
			width: 640px;
			height: 360px;
		}
		#canvas-output1:hover {
			width: 1920px;
			height: 1080px;
		}*/
	</style>
</head>
<body>
	<script data-src="../../forth.fs;../../browser.fs" type="application/sforth"></script>

	<div id="camera-image"></div>
	<canvas id="canvas-output1"></canvas>

	<script type="application/sforth">
		"canvas-output1 document.getElementById(1) { canvas }
		"2d canvas.getContext(1) { ctx }

		:js processImage { image }
			' image.width to canvas.width
			' image.height to canvas.height

			' image.data { src }

			image ctx.createImageData(1) { output }
			' output.data { dst }

			0 ' image.height 1 do y
				m* y image.width { y-pos }
				m* y-pos 4 { y-pos }
				0 ' image.width 1 do x
					m* x 4 { i }
					m+ i y-pos { i }

					m+ i 1 { ig }
					m+ i 2 { ib }
					m+ i 3 { ia }

					m@ src i { r }
					m@ src ig { g }
					m@ src ib { b }
					m@ src ia { a }
					m! dst i b
					m! dst ig g
					m! dst ib r
					m! dst ia a
				loop
			loop

			' output 0 0 ctx.putImageData
			 20 20 800 400 ctx.rect
			"1 to ctx.lineWidth
			"red to ctx.strokeStyle
			ctx.stroke
		;

		// "#camera-image"
		null
		:[ {
			video: {
				mandatory: {
					minWidth: 1920,
					minHeight: 1080
				}
			}
		} ]: new CameraInterface { cameraInterface }

		"error ' console-log cameraInterface.on
		"newImage ' processImage cameraInterface.on

		cameraInterface.start
	</script>

</body>
</html>
