<!DOCTYPE html>
<html>
<head>
	<script>sforthThrowIfUnderflow=true</script>
	<meta charset="utf-8"/>
	<title>Editor</title>
	<script src="../../ext/jquery-2.1.0.min.js"></script>
	<script src="../../sforth-runtime.js"></script>
	<script src="../../sforth.js"></script>
</head>
<body onload="forth.compileAllScriptRegions();">
	<script data-src="../../forth.fs" type="application/sforth"></script>
	<script data-src="../../browser.fs" type="application/sforth"></script>

	<textarea id="forth_src" cols="50" rows="10"></textarea>
	<textarea id="code_tree" cols="50" rows="10"></textarea>
	<textarea id="js_src" cols="50" rows="10"></textarea>
	<textarea id="compiler_errors" cols="50" rows="10"></textarea>

	<input type="button" value="Execute" onclick="eval($('#js_src').val());">

	<script>
		forth.compiler_message_handler = function(msg) { 
			$('#compiler_errors').val($('#compiler_errors').val() + "\n" + msg);
		};
		
		var oldVal = "";
	$("#forth_src").on("change keyup paste", function() {
		var currentVal = $(this).val();
		if(currentVal == oldVal) {
			return; //check to prevent multiple simultaneous triggers
		}

		oldVal = currentVal;
		$('#compiler_errors').val("");
		try {
			var code = $('#forth_src').val();
			var tokens = forth.tokenize(code)
			var code_tree = forth.createFromForthTokens(tokens);
			var optimized_code_tree = forth.optimizeCodeTree(code_tree);
			$('#code_tree').val(JSON.stringify(optimized_code_tree, null, "\t"));
			var generated_code = forth.generateJsCode(optimized_code_tree);
			$('#js_src').val(generated_code);
		} catch(err) {
			forth.compiler_message_handler(err);
		}
	});
	</script>

</body>
</html>
