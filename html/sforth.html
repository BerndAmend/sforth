<!DOCTYPE html>
<html>
<head>
	<title>Image processing</title>
	<script type="text/javascript" src="jquery-2.1.0.min.js"></script>
	<script type="text/javascript" src="image-processing.js"></script>
	<script type="text/javascript" src="../sforth-runtime.js"></script>
	<script type="text/javascript" src="../sforth.js"></script>
	<script type="text/javascript" src="../forth.fs.js"></script>
	
	
</head>
<body>
	
	<div id="camera-image" style=""></div>
	<canvas id="canvas-output1"></canvas>
	
	<textarea id="forth_src" cols="50" rows="10">:[ console.log("Test") ];</textarea>
	<textarea id="js_src" cols="50" rows="10"></textarea>
	<textarea id="compiler_errors" cols="50" rows="10"></textarea>
	
	<input type="button" value="Compile"
      onclick="$('#js_src').val(forth.compile($('#forth_src').val()));">
      
      <input type="button" value="Execute"
      onclick="eval($('#js_src').val());">

	<script type="text/javascript" src="../bv.fs.js"></script>
	<script type="text/javascript">
	
		forth.compiler_message_handler = function(msg) { 
			$('#compiler_errors').val($('#compiler_errors').val() + "\n" + msg);
		};
		//(function(){
		
		var oldVal = "";
	$("#forth_src").on("change keyup paste", function() {
		var currentVal = $(this).val();
		if(currentVal == oldVal) {
			return; //check to prevent multiple simultaneous triggers
		}

		oldVal = currentVal;
		$('#compiler_errors').val("");
		try {
			$('#js_src').val(forth.compile($('#forth_src').val()));
		} catch(err) {
			forth.compiler_message_handler(err);
		}
		//eval($('#js_src').val());
	});
		
			var canvas = document.getElementById('canvas-output1');
			var ctx = canvas.getContext('2d');
			
			//var canvas2 = document.getElementById('canvas-output2');
			//var ctx2 = canvas2.getContext('2d');
		
			// "#camera-image",
			var cameraInterface = new CameraInterface(null,
			{
				video: {
					mandatory: {
						minWidth: 1920,
						minHeight: 1080
					}
				}
			});
			
			cameraInterface.on('error', function(err) {
				console.log('error');
			});
			
			var processImageFunc = processImage;
			
			var localNewImageForthStack = new ForthStack();
			
			cameraInterface.on('newImage', function(image) {
				canvas.width = image.width;
				canvas.height = image.height;
				dst = image.data;

				localNewImageForthStack.push(image);
				processImageFunc(localNewImageForthStack);
				
				ctx.putImageData(image, 0, 0);
				
				ctx.rect(20,20,150,100);
				//ctx.lineWidth="1";
				//ctx.strokeStyle="red";
				//ctx.stroke();
			});
			
			cameraInterface.start();
		//})();
	</script>

</body>
</html>
